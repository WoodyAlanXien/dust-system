{{!-- Components --}}
{{#*inline "pip"}}
    <button type="button" class="{{ classes }}" data-n="{{ n }}" data-tooltip="{{ tooltip }}" aria-label="{{ label }}"
            aria-pressed="{{ filled }}"></button>
{{/inline}}

<form class="{{ cssClass }}" autocomplete="off">

    {{!-- Header --}}
    <header class="sheet-header">

        {{!-- Portrait & Vitals --}}
        <div class="left">

            {{!-- Portrait --}}
            {{#if editable}}
            <label class="slide-toggle">
                <input type="checkbox" name="flags.dust-system.showTokenPortrait" {{ checked portrait.token }}>
                {{#if portrait.token}}
                    {{ localize "DOCUMENT.Token" }}
                    <i class="fas fa-toggle-on"></i>
                {{else}}
                    {{ localize "DUST.Portrait" }}
                    <i class="fas fa-toggle-off"></i>
                {{/if}}
            </label>
            {{/if}}

            <div class="portrait {{#if portrait.token}}token{{/if}}">

                <img src="{{ portrait.src }}" alt="{{ actor.name }}"
                     {{#if (and editable portrait.path)}}data-edit="{{ portrait.path }}"{{/if}}>

                {{#if showDeathSaves}}
                <div class="death-saves">
                    <button type="button" data-action="rollDeathSave" data-tooltip="DUST.DeathSaveRoll"
                            aria-label="{{ localize "DUST.DeathSaveRoll" }}"
                            class="{{ rollableClass }} death-save unbutton">
                        <dust-system-icon src="systems/dust-system/icons/svg/statuses/dead-outline.svg"></dust-system-icon>
                    </button>

                    {{#with system.attributes.death}}
                    <div class="results">

                        {{!-- Successes --}}
                        <div class="success">
                            <input type="text" name="system.attributes.death.success" data-dtype="Number"
                                   inputmode="numeric" pattern="[+=\-]?\d*" placeholder="0" value="{{ success }}"
                                   aria-label="{{ localize "DUST.DeathSaveSuccessLabel" }}">
                            <i class="fa-solid fa-circle-check" inert></i>
                        </div>

                        {{!-- Failures --}}
                        <div class="failure">
                            <input type="text" name="system.attributes.death.failure" data-dtype="Number"
                                   inputmode="numeric" pattern="[+=\-]?\d*" placeholder="0" value="{{ failure }}"
                                   aria-label="{{ localize "DUST.DeathSaveFailureLabel" }}">
                            <i class="fa-solid fa-circle-xmark" inert></i>
                        </div>
                    </div>
                    {{/with}}
                </div>
                {{/if}}

                {{!-- Initiative --}}
                <div class="initiative-wrapper">

                    {{!-- Initiative Modifier --}}
                    <div class="initiative {{#unless editable}}{{ rollableClass }}{{/unless}}"
                        {{#if editable}}data-tooltip="DUST.InitiativeConfig"
                         aria-label="{{ localize "DUST.InitiativeConfig" }}"
                        {{else}}data-tooltip="DUST.Initiative" aria-label="{{ localize "DUST.Initiative" }}"
                         data-action="rollInitiative"{{/if}}>
                        {{#if editable}}
                        <a class="config-button" data-action="initiative"><i class="fas fa-cog"></i></a>
                        {{else}}
                        <span>{{ dust-system-numberFormat system.attributes.init.total signDisplay="always" }}</span>
                        {{/if}}
                    </div>

                    {{!-- Initiative Score --}}
                    {{#if showInitiativeScore}}
                    <div class="initiative-score">{{ system.attributes.init.score }}</div>
                    {{/if}}
                </div>

                {{!-- Loyalty --}}
                {{#if showLoyalty}}
                <div class="loyalty-badge badge" aria-label="{{ localize "DUST.Loyalty" }}"
                     {{#unless editable}}data-tooltip="DUST.Loyalty"{{/unless}}>
                    {{#if editable}}
                    <input type="text" class="uninput" name="system.attributes.loyalty.value" inputmode="numeric"
                           pattern="[+=\-]?\d*" placeholder="—" value="{{ source.attributes.loyalty.value }}"
                           data-dtype="Number">
                    {{else if system.attributes.loyalty.value includeZero=true}}
                    {{ system.attributes.loyalty.value }}
                    {{else}}
                    &mdash;
                    {{/if}}
                </div>
                {{/if}}
            </div>

            {{!-- Vitals --}}
            <div class="bottom vitals">

                {{!-- AC --}}
                <div class="left ac">

                    <div class="ac-badge badge" aria-label="{{ localize "DUST.ArmorClass" }}">
                        {{#if editable}}
                        <a class="config-button" data-action="armor" data-tooltip="DUST.ArmorConfig"
                           aria-label="{{ localize "DUST.ArmorConfig" }}">
                            <i class="fas fa-cog"></i>
                        </a>
                        {{else}}
                        <div data-attribution="attributes.ac" data-attribution-caption="DUST.ArmorClass"
                             data-tooltip-direction="DOWN">
                            {{ system.attributes.ac.value }}
                        </div>
                        {{/if}}
                    </div>

                </div>

                {{!-- HP --}}
                <div class="right">

                    {{!-- HP --}}
                    {{#with system.attributes.hp}}
                    <div class="meter hit-points sectioned">
                        <div class="progress hit-points {{#if (gt tempmax 0)}}temp-positive{{else if (lt tempmax 0)}}temp-negative{{/if}}"
                             role="meter" aria-valuemin="0" aria-valuenow="{{ value }}" aria-valuemax="{{ max }}"
                             style="--bar-percentage: {{ pct }}%">
                            <div class="label">
                                <span class="value">{{ value }}</span>
                                <span class="separator">&sol;</span>
                                <span class="max">{{ effectiveMax }}</span>
                                {{#if tempmax}}
                                <span class="bonus">{{ dust-system-numberFormat tempmax signDisplay="always" }}</span>
                                {{/if}}
                                {{#if @root.editable}}
                                <a class="config-button" data-action="hitPoints" data-tooltip="DUST.HitPointsConfig"
                                   aria-label="{{ localize "DUST.HitPointsConfig" }}">
                                    <i class="fas fa-cog"></i>
                                </a>
                                {{/if}}
                            </div>
                            <input type="text" name="system.attributes.hp.value" data-dtype="Number" placeholder="0"
                                   value="{{ value }}" inputmode="numeric" pattern="[+=\-]?\d*" hidden>
                        </div>
                        {{#if showDeathSaves}}
                        <div class="tmp">
                            <input type="text" name="system.attributes.hp.temp" data-dtype="Number" inputmode="numeric"
                                   placeholder="{{ localize "DUST.TMP" }}" value="{{ temp }}" pattern="[+=\-]?\d*">
                        </div>
                        {{/if}}
                    </div>
                    {{/with}}

                    {{!-- Temp & Tempmax --}}
                    {{#with system.attributes.hp}}
                    <div class="meter sectioned split">
                        <div class="temp">
                            <input type="text" name="system.attributes.hp.temp" data-dtype="Number" inputmode="numeric"
                                   placeholder="{{ localize "DUST.TMP" }}" value="{{#if temp}}{{ temp }}{{/if}}"
                                   pattern="[+=\-]?\d*">
                        </div>
                        <div class="tempmax">
                            <input type="text" name="system.attributes.hp.tempmax" data-dtype="Number"
                                   inputmode="numeric" placeholder="+{{ localize "DUST.Max" }}"
                                   value="{{#if tempmax}}{{ tempmax }}{{/if}}" pattern="[+=\-]?\d*">
                        </div>
                    </div>
                    {{/with}}

                </div>

            </div>

        </div>

        {{!-- Ability Scores & Other Statistics --}}
        <div class="right stats">

            <div class="top">

                {{!-- Name, Type, Size, & Alignment --}}
                <div class="left">

                    {{!-- Name --}}
                    {{#if editable}}
                    <input type="text" name="name" class="document-name uninput" value="{{ actor.name }}">
                    {{else}}
                    <div class="document-name">{{ actor.name }}</div>
                    {{/if}}

                    {{!-- Size, Type, & Alignment --}}
                    <ul class="labels unlist">

                        {{!-- Size --}}
                        <li class="creature-size">
                            {{#if editable}}
                            <select class="unselect" name="system.traits.size">
                                {{ selectOptions config.actorSizes selected=source.traits.size labelAttr="label" }}
                            </select>
                            {{else}}
                            <span>{{ lookup (lookup config.actorSizes system.traits.size) "label" }}</span>
                            {{/if}}
                        </li>

                        {{!-- Type --}}
                        <li class="creature-type">
                            {{#if editable}}
                            <a class="config-button" data-action="type" data-tooltip="DUST.CreatureTypeConfig"
                               aria-label="{{ localize "DUST.CreatureTypeConfig" }}">
                                <span>{{ labels.type }}</span>
                                <i class="fas fa-cog"></i>
                            </a>
                            {{else}}
                            <span>{{ labels.type }}</span>
                            {{/if}}
                        </li>

                        {{!-- Alignment --}}
                        <li class="creature-alignment">
                            {{#if editable}}
                            <input type="text" name="system.details.alignment" value="{{ source.details.alignment }}"
                                   placeholder="{{ localize "DUST.Alignment" }}">
                            {{else}}
                            <span>{{ system.details.alignment }}</span>
                            {{/if}}
                        </li>

                    </ul>

                </div>

                {{!-- Resting, Special Traits, & Proficiency --}}
                {{#if actor.isOwner}}
                <div class="right">

                    <div class="left">

                        <div class="sheet-header-buttons">
                            <button type="button" class="short-rest gold-button" data-tooltip="DUST.REST.Short.Label"
                                    aria-label="{{ localize "DUST.REST.Short.Label" }}">
                                <i class="fas fa-utensils"></i>
                            </button>
                            <button type="button" class="long-rest gold-button" data-tooltip="DUST.REST.Long.Label"
                                    aria-label="{{ localize "DUST.REST.Long.Label" }}">
                                <i class="fas fa-campground"></i>
                            </button>
                        </div>

                        <div class="proficiency">
                            <span>{{ localize "DUST.Proficiency" }}</span>
                            <strong>{{ dust-system-formatModifier system.attributes.prof }}</strong>
                        </div>

                    </div>

                    {{!-- CR --}}
                    <div class="right cr-badge badge" aria-label="{{ localize "DUST.CRLabel" cr=system.details.cr }}"
                         {{#unless editable}}data-tooltip="DUST.ChallengeRating"{{/unless}}>
                        {{#if editable}}
                        <input type="text" class="uninput" name="system.details.cr"
                               value="{{ dust-system-formatCR source.details.cr }}">
                        {{else}}
                        {{{ dust-system-formatCR system.details.cr }}}
                        {{/if}}
                    </div>

                </div>
                {{/if}}

            </div>

            {{!-- Ability Scores --}}
            <div class="middle ability-scores card flexrow">
                {{#each abilities}}
                <div class="ability-score" data-ability="{{ key }}">
                    {{#if icon}}<img src="{{ icon }}" alt="{{ label }}">{{/if}}
                    <a class="label {{ @root.rollableClass }} ability-check">{{ abbr }}</a>
                    <div class="mod">
                        {{#if @root.editable}}
                        <a class="config-button" data-action="ability"
                           data-tooltip="{{ localize "DUST.AbilityConfigure" ability=label }}"
                           aria-label="{{ localize "DUST.AbilityConfigure" ability=label }}">
                            <i class="fas fa-cog"></i>
                        </a>
                        {{else}}
                        {{ dust-system-formatModifier mod }}
                        {{/if}}
                    </div>
                    <div class="score">
                        {{#if @root.editable}}
                        <input type="text" name="system.abilities.{{ key }}.value" value="{{ baseValue }}"
                               placeholder="10" data-dtype="Number" class="uninput">
                        {{else}}
                        {{ value }}
                        {{/if}}
                    </div>
                    <div class="save-tab saving-throw {{#unless @root.editable}}{{ @root.rollableClass }}{{/unless}}"
                         {{#unless @root.editable}}data-tooltip="{{ localize "DUST.SavingThrowRoll" ability=label }}"
                         aria-label="{{ localize "DUST.SavingThrowRoll" ability=label }}"{{/unless}}>
                        <proficiency-cycle type="ability" name="{{ concat "system.abilities." key ".proficient" }}"
                                           data-tooltip="{{ hover }}" aria-label="{{ localize hover }}"
                                           value="{{#if @root.editable}}{{ baseProf }}{{else}}{{ proficient }}{{/if}}"
                                           {{ disabled (not @root.editable) }}></proficiency-cycle>
                        <span class="save">{{ dust-system-formatModifier save.value }}</span>
                        <i class="fas fa-shield-heart" inert></i>
                    </div>
                </div>
                {{/each}}
            </div>

            {{!-- Legendary Actions & Resistances, Lair Actions, & Classes --}}
            <div class="bottom">

                {{#if hasClasses}}
                {{> "dust-system.actor-classes" }}
                {{/if}}

                {{#if (or hasLegendaries editable)}}
                <div class="legendary">
                    {{#if editable}}
                    <label class="legact">
                        <span class="label roboto-upper">{{ localize "DUST.LegendaryAction.Label" }}</span>
                        {{ numberInput source.resources.legact.max name="system.resources.legact.max" step=1 min=0 }}
                    </label>
                    <label class="legres">
                        <span class="label roboto-upper">{{ localize "DUST.LegendaryResistance.Label" }}</span>
                        {{ numberInput source.resources.legres.max name="system.resources.legres.max" step=1 min=0 }}
                    </label>
                    <label class="lair">
                        {{#if modernRules}}
                        <span class="label roboto-upper">{{ localize "DUST.LAIR.HasLair" }}</span>
                        <div class="spacer checkbox">
                            <dust-system-checkbox name="system.resources.lair.value"
                                            {{ checked source.resources.lair.value }}></dust-system-checkbox>
                        </div>
                        {{else}}
                        <span class="label roboto-upper">{{ localize "DUST.LAIR.Action.Label" }}</span>
                        {{ numberInput source.resources.lair.initiative name="system.resources.lair.initiative"
                                       placeholder="—" step=1 min=0 }}
                        {{/if}}
                    </label>
                    {{else}}
                    {{#if system.resources.legact.max}}
                    <div class="legact">
                        <span class="label roboto-upper">{{ localize "DUST.LegendaryAction.Label" }}</span>
                        <div class="pips" data-prop="system.resources.legact.value">
                            {{#each legact}}
                                {{> pip }}
                            {{/each}}
                        </div>
                    </div>
                    {{/if}}
                    {{#if system.resources.legres.max}}
                    <div class="legres">
                        <span class="label roboto-upper">{{ localize "DUST.LegendaryResistance.Label" }}</span>
                        <div class="pips" data-prop="system.resources.legres.value">
                            {{#each legres}}
                                {{> pip }}
                            {{/each}}
                        </div>
                    </div>
                    {{/if}}
                    {{#if modernRules}}
                    {{#if system.resources.lair.value}}
                    <label class="lair">
                        <span class="label roboto-upper">{{ localize "DUST.LAIR.Inside" }}</span>
                        <div class="spacer toggle">
                            <slide-toggle name="system.resources.lair.inside"
                                          {{ checked system.resources.lair.inside }}></slide-toggle>
                        </div>
                    </label>
                    {{/if}}
                    {{else if system.resources.lair.initiative}}
                    <label class="lair">
                        <span class="label roboto-upper">{{ localize "DUST.LAIR.Action.Label" }}</span>
                        <span class="value">{{ system.resources.lair.initiative }}</span>
                    </label>
                    {{/if}}
                    {{/if}}
                </div>
                {{/if}}

            </div>

        </div>

    </header>

    {{!-- Body --}}
    <section class="sheet-body">

        {{!-- Main Content --}}
        <div class="main-content">

            {{!-- Sidebar Collapser --}}
            <button type="button" class="sidebar-collapser unbutton interface-only"
                {{#if sidebarCollapsed}}
                data-tooltip="JOURNAL.ViewExpand" aria-label="{{ localize "JOURNAL.ViewExpand" }}"
                {{else}}
                data-tooltip="JOURNAL.ViewCollapse" aria-label="{{ localize "JOURNAL.ViewCollapse" }}"
                {{/if}}>
                <i class="fas fa-caret-{{#if sidebarCollapsed}}right{{else}}left{{/if}}"></i>
            </button>

            {{!-- Sidebar --}}
            <div class="sidebar">

                {{!-- HD --}}
                {{#if important}}
                {{#with system.attributes.hd}}
                <div class="pills-group empty">
                    {{!-- TODO: Allow clicking this to roll a hit die --}}
                    <h3 class="icon">
                        <i class="fa-solid fa-dice-d{{ denomination }}"></i>
                        <span class="roboto-upper">{{ localize "DUST.HitDice" }}</span>
                        <span class="counter">{{ value }} &sol; {{ max }}</span>
                    </h3>
                </div>
                {{/with}}
                {{/if}}

                {{!-- Speed --}}
                {{> "dust-system.actor-trait-pills" values=speed key="speed" icon="fas fa-shoe-prints"
                    label="DUST.Speed" configAction="movement" }}

                {{!-- Skills --}}
                <div class="pills-group {{#unless skills}}empty{{/unless}}">
                    <h3 class="icon">
                        <i class="fas fa-briefcase"></i>
                        <span class="roboto-upper">{{ localize "DUST.Skills" }}</span>
                        {{#if editable}}
                        <a class="config-button" data-action="skills" data-tooltip="DUST.SkillsConfig"
                           aria-label="{{ localize "DUST.SkillsConfig" }}">
                            <i class="fas fa-cog"></i>
                        </a>
                        {{/if}}
                    </h3>
                    <ul class="pills">
                        {{#each skills}}
                        <li class="pill">
                            <a class="{{ @root.rollableClass }} skill-name" data-key="{{ @key }}">
                                <span class="label">{{ label }}</span>
                                <span class="separator">&vert;</span>
                                <span class="value">{{ dust-system-numberFormat total signDisplay="always" }}</span>
                            </a>
                        </li>
                        {{/each}}
                    </ul>
                </div>

                {{!-- Senses --}}
                {{> "dust-system.actor-trait-pills" values=senses key="senses" icon="fas fa-eye"
                    label="DUST.Senses" configAction="senses" }}

                {{!-- Resistances --}}
                {{> "dust-system.actor-trait-pills" values=traits.dr key="dr" color="green" icon="fas fa-shield-halved"
                    label="DUST.Resistances" }}

                {{!-- Immunities --}}
                {{#if editable}}
                    {{> "dust-system.actor-trait-pills" values=traits.di key="di" color="green" icon="fas fa-shield"
                        label="DUST.DamImm" }}
                {{else}}
                    {{> "dust-system.actor-trait-pills" values=traits.di key="di" color="green" icon="fas fa-shield"
                        label="DUST.Immunities" }}
                {{/if}}
                {{> "dust-system.actor-trait-pills" values=traits.ci key="ci" color="green" svg="rosa-shield"
                    label="DUST.ConImm" }}

                {{!-- Vulnerabilities --}}
                {{> "dust-system.actor-trait-pills" values=traits.dv key="dv" color="maroon" icon="fas fa-heart-crack"
                    label="DUST.Vulnerabilities" }}

                {{!-- Damage Modification --}}
                {{> "dust-system.actor-trait-pills" values=traits.dm key="dm" icon="fas fa-heart-circle-plus"
                    label="DUST.DamageModification.Label" }}

                {{!-- Languages --}}
                {{> "dust-system.actor-trait-pills" values=traits.languages key="languages" icon="fas fa-flag"
                    label="DUST.Languages" }}

                {{!-- Habitat --}}
                {{#if (or editable habitat)}}
                <div class="pills-group {{#unless habitat}}empty{{/unless}}">
                    <h3 class="icon">
                        <i class="fa-solid fa-mountain-sun" inert></i>
                        <span class="roboto-upper">{{ localize "DUST.Habitat.Configuration.Label" }}</span>
                        {{#if editable}}
                        <a class="config-button" data-action="habitat" data-tooltip="DUST.Habitat.Configuration.Title"
                           aria-label="{{ localize "DUST.Habitat.Configuration.Title" }}">
                            <i class="fa-solid fa-cog" inert></i>
                        </a>
                        {{/if}}
                    </h3>
                    <ul class="pills">
                        {{#each habitat}}
                        <li class="pill">
                            <span class="label">{{ label }}</span>
                        </li>
                        {{/each}}
                    </ul>
                </div>
                {{/if}}

                {{!-- Treasure --}}
                {{!-- TODO: Allow clicking a treasure category pill to roll appropriately for random treasure --}}
                {{#if (or editable treasure)}}
                <div class="pills-group {{#unless treasure}}empty{{/unless}}">
                    <h3 class="icon">
                        <i class="fa-solid fa-gem" inert></i>
                        <span class="roboto-upper">{{ localize "DUST.Treasure.Configuration.Label" }}</span>
                        {{#if editable}}
                        <a class="config-button" data-action="treasure"
                           data-tooltip="DUST.Treasure.Configuration.Title"
                           aria-label="{{ localize "DUST.Treasure.Configuration.Title" }}">
                            <i class="fa-solid fa-cog" inert></i>
                        </a>
                        {{/if}}
                    </h3>
                    <ul class="pills">
                        {{#each treasure}}
                        <li class="pill">
                            <span class="label">{{ label }}</span>
                        </li>
                        {{/each}}
                    </ul>
                </div>
                {{/if}}

            </div>

            {{!-- Tabbed Content --}}
            <section class="tab-body">

                {{!-- Features --}}
                <div class="tab features" data-group="primary" data-tab="features">
                    {{> "dust-system.creature-features" sections=features.sections filters=features.filters }}
                </div>

                {{!-- Inventory --}}
                <div class="tab inventory" data-group="primary" data-tab="inventory">
                    {{> "dust-system.inventory2" sections=inventory }}
                </div>

                {{!-- Spells --}}
                <div class="tab spells" data-group="primary" data-tab="spells">
                    {{> "dust-system.creature-spells" }}
                </div>

                {{!-- Effects --}}
                <div class="tab effects" data-group="primary" data-tab="effects">
                    {{> "dust-system.active-effects2" }}
                </div>

                {{!-- Biography --}}
                {{~> "dust-system.npc-biography" ~}}

                {{!-- Special Traits --}}
                <div class="tab special-traits" data-group="primary" data-tab="special-traits">
                    {{~> "dust-system.creature-special-traits" ~}}
                </div>

            </section>

        </div>

    </section>

    {{!-- Child Creation --}}
    <button type="button" class="create-child gold-button"
            aria-label="{{ localize "SIDEBAR.Create" type=(localize "DOCUMENT.Item") }}">
        <i class="fas fa-plus"></i>
    </button>

    {{!-- Warnings --}}
    {{> "dust-system.actor-warnings-dialog" }}

</form>
